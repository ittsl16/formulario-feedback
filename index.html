<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Retroalimentación</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- NUEVAS DEPENDENCIAS AGREGADAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-color: #CF002E;
            --secondary-color: #FDD000;
            --gradient-start: #FFFFFF;
            --gradient-end: #FDD000;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #333333;
            --text-color: #333333;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            padding: 20px;
            border-bottom: 3px solid var(--primary-color);
            margin-bottom: 30px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo-text h1 {
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
            font-size: 1.5rem;
        }
        
        .logo-text p {
            font-weight: 300;
            color: var(--dark-gray);
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Navegación */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        
        .nav-tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            flex: 1;
            text-align: center;
        }
        
        .nav-tab:hover {
            background-color: var(--light-gray);
        }
        
        .nav-tab.active {
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(207, 0, 46, 0.05);
            color: var(--primary-color);
            font-weight: 700;
        }
        
        /* Contenido principal */
        .content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Formularios */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .required::after {
            content: " *";
            color: var(--primary-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(207, 0, 46, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .radio-option input, .checkbox-option input {
            width: auto;
            margin-top: 3px;
        }
        
        /* Sección del colaborador */
        .colaborador-section {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }
        
        .colaborador-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .colaborador-section .info-text {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        /* Subir imagen */
        .image-upload {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-upload:hover {
            border-color: var(--primary-color);
            background-color: rgba(207, 0, 46, 0.02);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: var(--border-radius);
            display: none;
        }
        
        /* Botones */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #a00024;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--dark-gray);
        }
        
        .btn-secondary:hover {
            background-color: #e6b800;
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: rgba(207, 0, 46, 0.05);
        }
        
        /* Firma digital */
        .signature-container {
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .signature-canvas {
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            background-color: white;
            width: 100%;
            height: 150px;
            margin-bottom: 15px;
            cursor: crosshair;
            touch-action: none;
            display: block;
        }
        
        .signature-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Panel de administrador */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--dark-gray);
            opacity: 0.8;
        }
        
        /* Tabla */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            background-color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1100px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        th {
            background-color: var(--light-gray);
            font-weight: 700;
            color: var(--primary-color);
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: rgba(253, 208, 0, 0.1);
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-escrita {
            background-color: #FDD000;
            color: var(--dark-gray);
        }
        
        .badge-verbal {
            background-color: #CF002E;
            color: white;
        }
        
        /* Modal de edición */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 15px;
        }
        
        .modal-header h2 {
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-gray);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
                justify-content: center;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 20px auto;
            }
        }
        
        /* Modo solo formulario (sin admin) */
        .public-mode .admin-only {
            display: none !important;
        }
        
        .public-mode header {
            justify-content: center;
        }
        
        .user-role {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--secondary-color);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .info-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .lider-otro-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }
        
        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        /* Mejoras para canvas de firmas */
.signature-canvas {
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius);
    background-color: white;
    width: 100%;
    height: 150px;
    margin-bottom: 15px;
    cursor: crosshair;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.signature-container {
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius);
    padding: 15px;
    margin-bottom: 20px;
    position: relative;
    background-color: #fafafa;
}

/* Indicador de firma requerida */
.signature-container.required::before {
    content: "*";
    color: var(--primary-color);
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 18px;
    font-weight: bold;
}

/* Mejoras para móvil */
@media (max-width: 768px) {
    .signature-canvas {
        height: 120px;
    }
    
    .signature-container {
        padding: 10px;
    }
    
    .signature-controls {
        flex-direction: column;
        gap: 10px;
    }
    
    .signature-controls button {
        width: 100%;
    }
}

/* Efecto al dibujar */
.signature-canvas:active {
    box-shadow: 0 0 0 2px rgba(207, 0, 46, 0.1);
}

/* Mensaje para móvil */
.mobile-signature-warning {
    display: none;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    color: #856404;
}

@media (max-width: 768px) {
    .mobile-signature-warning {
        display: block;
    }
}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h2><i class="fas fa-lock"></i> Acceso al Sistema</h2>
        <div class="form-group">
            <label for="user-role">Tipo de usuario</label>
            <select id="user-role" required>
                <option value="">Seleccionar rol</option>
                <option value="supervisor">Supervisor/Coordinador</option>
                <option value="admin">Administrador</option>
            </select>
        </div>
        <div class="form-group">
            <label for="user-password">Contraseña</label>
            <input type="password" id="user-password" placeholder="Ingrese su contraseña">
        </div>
        <div class="button-group">
            <button type="button" class="btn btn-primary" id="btn-login">
                <i class="fas fa-sign-in-alt"></i> Ingresar
            </button>
        </div>
        <div id="login-error" class="alert alert-error hidden">
            <i class="fas fa-exclamation-circle"></i>
            <span>Credenciales incorrectas. Intente nuevamente.</span>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div id="app" class="hidden">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="logo-text">
                    <h1>Formulario de Retroalimentación <span id="user-role-display" class="user-role"></span></h1>
                    <p>Gestión de feedbacks</p>
                </div>
            </div>
            <div>
                <button class="btn btn-outline" id="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </header>
        
        <div class="container">
            <!-- Navegación para supervisores -->
            <div class="nav-tabs supervisor-only">
                <div class="nav-tab active" data-tab="form-escrita">
                    <i class="fas fa-edit"></i> Retroalimentación Escrita
                </div>
                <div class="nav-tab" data-tab="form-verbal">
                    <i class="fas fa-comment"></i> Retroalimentación Verbal
                </div>
            </div>
            
            <!-- Navegación para admin -->
            <div class="nav-tabs admin-only hidden">
                <div class="nav-tab active" data-tab="admin">
                    <i class="fas fa-chart-bar"></i> Panel Administrador
                </div>
            </div>
            
            <!-- Formulario de retroalimentación escrita -->
            <div id="form-escrita" class="content supervisor-only">
                <h2><i class="fas fa-edit"></i> Retroalimentación Escrita</h2>
                <p>Complete el formulario para registrar una llamada de atención escrita.</p>
                
                <div id="escrita-success" class="alert alert-success hidden">
                    <i class="fas fa-check-circle"></i>
                    <span>¡Retroalimentación registrada exitosamente!</span>
                </div>
                
                <form id="formEscrita">
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Información General</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="folio-escrita">Folio</label>
                                <input type="text" id="folio-escrita" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fecha-escrita">Fecha</label>
                                <input type="date" id="fecha-escrita" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Tipo de Feedback</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="motivacion" name="tipo-feedback-escrita" value="Motivación" checked>
                                    <label for="motivacion">Motivación</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="desarrollo" name="tipo-feedback-escrita" value="Desarrollo">
                                    <label for="desarrollo">Desarrollo</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="area" class="required">Área</label>
                            <select id="area" required>
                                <option value="">Seleccionar área</option>
                                <option value="Operaciones">Operaciones</option>
                                <option value="PFCT">PFCT</option>
                                <option value="CRYD">CRYD</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="form-group hidden" id="area-otro-container">
                            <label for="area-otro" class="required">Especifique el área</label>
                            <input type="text" id="area-otro" placeholder="Ingrese el nombre del área">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-user-tie"></i> Información del Líder y Colaborador</h3>
                        
                        <div class="form-group">
                            <label for="lider" class="required">Líder que retroalimenta</label>
                            <select id="lider" required>
                                <option value="">Seleccionar líder</option>
                                <!-- Opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        
                        <!-- NUEVO CAMPO: Cuadrilla del Líder -->
                        <div class="form-group">
                            <label for="cuadrilla-lider" class="required">Cuadrilla del líder</label>
                            <select id="cuadrilla-lider" required>
                                <option value="">Seleccionar cuadrilla</option>
                                <option value="A"> A</option>
                                <option value="B"> B</option>
                                <option value="C">C</option>
                                <option value="D"> D</option>
                                <option value="Otra">Otra</option>
                            </select>
                        </div>
                        
                        <!-- NUEVO CAMPO: Nombre del Colaborador -->
                        <div class="form-group">
                            <label for="nombre-colaborador" class="required">Nombre del colaborador</label>
                            <input type="text" id="nombre-colaborador" placeholder="Nombre completo del colaborador" required>
                        </div>
                        
                        <div class="form-group hidden" id="lider-otro-container">
                            <div class="lider-otro-container">
                                <label for="lider-otro-nombre" class="required">Nombre completo del líder</label>
                                <input type="text" id="lider-otro-nombre" placeholder="Nombre y apellidos del líder">
                                
                                <label for="lider-otro-puesto" class="required" style="margin-top: 10px;">Puesto del líder</label>
                                <input type="text" id="lider-otro-puesto" placeholder="Ej: Supervisor, Coordinador, etc.">
                                
                                <label for="lider-otro-area" class="required" style="margin-top: 10px;">Área del líder</label>
                                <input type="text" id="lider-otro-area" placeholder="Área o departamento del líder">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cuadrilla-colaborador" class="required">Cuadrilla del colaborador</label>
                                <select id="cuadrilla-colaborador" required>
                                    <option value="">Seleccionar cuadrilla</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="Ninguna">Otra</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="num-empleado" class="required">Número de empleado</label>
                                <input type="number" id="num-empleado" min="1000" max="999999" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> Detalles de la Retroalimentación</h3>
                        
                        <div class="form-group">
                            <label class="required">¿Qué impacto tiene la acción?</label>
                            <p class="info-text">Seleccione uno o más tipos de impacto:</p>
                            <div class="checkbox-group">
                                <div class="checkbox-option">
                                    <input type="checkbox" id="riesgo-seguridad" name="impacto" value="Riesgo por seguridad">
                                    <label for="riesgo-seguridad">Riesgo por seguridad</label>
                                </div>
                                <div class="checkbox-option">
                                    <input type="checkbox" id="riesgo-calidad" name="impacto" value="Riesgo por calidad">
                                    <label for="riesgo-calidad">Riesgo por calidad</label>
                                </div>
                                <div class="checkbox-option">
                                    <input type="checkbox" id="riesgo-inventario" name="impacto" value="Riesgo por inventario">
                                    <label for="riesgo-inventario">Riesgo por inventario</label>
                                </div>
                                <div class="checkbox-option">
                                    <input type="checkbox" id="riesgo-operativo" name="impacto" value="Riesgo operativo">
                                    <label for="riesgo-operativo">Riesgo operativo</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="descripcion-impacto" class="required">Descripción detallada del impacto</label>
                            <textarea id="descripcion-impacto" placeholder="Describa el impacto de la acción..." required></textarea>
                        </div>
                        
                        <!-- SECCIÓN DEL COLABORADOR (solo visible cuando ingresa su número) -->
                        <div class="colaborador-section hidden" id="seccion-colaborador">
                            <h4><i class="fas fa-user-lock"></i> Sección del Colaborador</h4>
                            <p class="info-text">Esta sección solo puede ser llenada por el colaborador.</p>
                            
                            <div class="form-group">
                                <label class="required">¿Por qué cree que ocurre el problema?</label>
                                <p class="info-text">Marque las opciones que apliquen:</p>
                                <div class="checkbox-vertical">
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="falta-capacitacion" name="causa-problema" value="Falta de capacitación">
                                        <label for="falta-capacitacion">Falta de capacitación</label>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="falta-herramientas" name="causa-problema" value="Falta de herramientas">
                                        <label for="falta-herramientas">Falta de herramientas</label>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="proceso-confuso" name="causa-problema" value="Proceso confuso">
                                        <label for="proceso-confuso">Proceso confuso</label>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="sobrecarga-trabajo" name="causa-problema" value="Sobrecarga de trabajo">
                                        <label for="sobrecarga-trabajo">Sobrecarga de trabajo</label>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="otra-causa" name="causa-problema" value="Otra">
                                        <label for="otra-causa">Otra</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="explicacion-causa-colaborador">Explique brevemente</label>
                                <textarea id="explicacion-causa-colaborador" placeholder="Explíquelo aquí..." rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="accion-diferente">¿Qué harías diferente dentro de tu proceso para prevenir errores similares?</label>
                                <textarea id="accion-diferente" placeholder="¿Por qué cree que ocurrió este error? ¿Qué podría hacerse diferente?"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="compromiso" class="required">¿Cuál es el compromiso del colaborador?</label>
                            <textarea id="compromiso" placeholder="Describa el compromiso..." required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-signature"></i> Firmas</h3>
                        <p>Complete las firmas de todas las personas involucradas.</p>
                        
                        <div class="form-row">
                            <div class="form-group"> 
                                <div class="signature-container">
                                    <p>Firma del colaborador:</p>
                                    <canvas class="signature-canvas" id="signature-canvas-colaborador"></canvas>
                                    <div class="signature-controls">
                                        <button type="button" class="btn btn-outline" id="clear-colaborador">
                                            <i class="fas fa-eraser"></i> Limpiar
                                        </button>
                                        <span>Dibuje su firma arriba</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="signature-container">
                                    <p>Firma del supervisor:</p>
                                    <canvas class="signature-canvas" id="signature-canvas-supervisor"></canvas>
                                    <div class="signature-controls">
                                        <button type="button" class="btn btn-outline" id="clear-supervisor">
                                            <i class="fas fa-eraser"></i> Limpiar
                                        </button>
                                        <span>Dibuje su firma arriba</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <div class="signature-container">
                                    <p>Firma del líder sindical:</p>
                                    <canvas class="signature-canvas" id="signature-canvas-sindical"></canvas>
                                    <div class="signature-controls">
                                        <button type="button" class="btn btn-outline" id="clear-sindical">
                                            <i class="fas fa-eraser"></i> Limpiar
                                        </button>
                                        <span>Dibuje su firma arriba</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="signature-container">
                                    <p>Firma de recursos humanos:</p>
                                    <canvas class="signature-canvas" id="signature-canvas-rh"></canvas>
                                    <div class="signature-controls">
                                        <button type="button" class="btn btn-outline" id="clear-rh">
                                            <i class="fas fa-eraser"></i> Limpiar
                                        </button>
                                        <span>Dibuje su firma arriba</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn btn-outline" id="reset-escrita">
                            <i class="fas fa-redo"></i> Limpiar Formulario
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar Retroalimentación
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Formulario de retroalimentación verbal -->
            <div id="form-verbal" class="content supervisor-only hidden">
                <h2><i class="fas fa-comment"></i> Retroalimentación Verbal</h2>
                <p>Complete el formulario para registrar una llamada de atención verbal.</p>
                
                <div id="verbal-success" class="alert alert-success hidden">
                    <i class="fas fa-check-circle"></i>
                    <span>¡Retroalimentación verbal registrada exitosamente!</span>
                </div>
                
                <form id="formVerbal">
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Información General</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="folio-verbal">Folio</label>
                                <input type="text" id="folio-verbal" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fecha-verbal">Fecha</label>
                                <input type="date" id="fecha-verbal" readonly>
                            </div>
                             <div class="form-group">
                     <label for="area-verbal" class="required">Área</label>
          <select id="area-verbal" required>
            <option value="">Seleccionar área</option>
            <option value="Operaciones">Operaciones</option>
            <option value="PFCT">PFCT</option>
            <option value="CRYD">CRYD</option>
            <option value="Otro">Otro</option>
        </select>
    </div>
    
    <div class="form-group hidden" id="area-verbal-otro-container">
        <label for="area-verbal-otro" class="required">Especifique el área</label>
        <input type="text" id="area-verbal-otro" placeholder="Ingrese el nombre del área">
    </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-user-tie"></i> Información de Líder y Colaborador</h3>
                        
                        <div class="form-group">
                            <label for="lider-verbal" class="required">Líder que retroalimenta</label>
                            <select id="lider-verbal" required>
                                <option value="">Seleccionar líder</option>
                                <!-- Opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        
                        <!-- NUEVO CAMPO: Cuadrilla del Líder (verbal) -->
                        <div class="form-group">
                            <label for="cuadrilla-lider-verbal" class="required">Cuadrilla del líder</label>
                            <select id="cuadrilla-lider-verbal" required>
                                <option value="">Seleccionar cuadrilla</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="Otra">Otra</option>
                            </select>
                        </div>
                        
                        <!-- NUEVO CAMPO: Nombre del Colaborador (verbal) -->
                        <div class="form-group">
                            <label for="nombre-colaborador-verbal" class="required">Nombre del colaborador</label>
                            <input type="text" id="nombre-colaborador-verbal" placeholder="Nombre completo del colaborador" required>
                        </div>
                        
                        <div class="form-group hidden" id="lider-verbal-otro-container">
                            <div class="lider-otro-container">
                                <label for="lider-verbal-otro-nombre" class="required">Nombre completo del líder</label>
                                <input type="text" id="lider-verbal-otro-nombre" placeholder="Nombre y apellidos del líder">
                                
                                <label for="lider-verbal-otro-puesto" class="required" style="margin-top: 10px;">Puesto del líder</label>
                                <input type="text" id="lider-verbal-otro-puesto" placeholder="Ej: Supervisor, Coordinador, etc.">
                                
                                <label for="lider-verbal-otro-area" class="required" style="margin-top: 10px;">Área del líder</label>
                                <input type="text" id="lider-verbal-otro-area" placeholder="Área o departamento del líder">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cuadrilla-verbal-colaborador" class="required">Cuadrilla del colaborador</label>
                                <select id="cuadrilla-verbal-colaborador" required>
                                    <option value="">Seleccionar cuadrilla</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="Otra">Otra</option>
                                    
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="num-empleado-verbal" class="required">Número de empleado</label>
                                <input type="number" id="num-empleado-verbal" min="1000" max="999999" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-image"></i> Evidencia (Opcional)</h3>
                        <p>Puede adjuntar una imagen relacionada con la retroalimentación verbal.</p>
                        
                        <div class="image-upload" id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--medium-gray); margin-bottom: 15px;"></i>
                            <p>Haga clic o arrastre una imagen aquí</p>
                            <p><small>Formatos aceptados: JPG, PNG, GIF (Máx. 5MB)</small></p>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;">
                        </div>
                        
                        <img id="image-preview" class="image-preview" alt="Vista previa de la imagen">
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> Detalles</h3>
                        
                        <div class="form-group">
                            <label for="razon-verbal" class="required">Razón de retroalimentación</label>
                            <textarea id="razon-verbal" placeholder="Describa la razón de la retroalimentación verbal..." required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-signature"></i> Firmas</h3>
                        <p>Complete las firmas del colaborador y coordinador/supervisor.</p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <div class="signature-container">
                                    <p>Firma del colaborador:</p>
                                    <canvas class="signature-canvas" id="signature-canvas-verbal-colaborador"></canvas>
                                    <div class="signature-controls">
                                        <button type="button" class="btn btn-outline" id="clear-verbal-colaborador">
                                            <i class="fas fa-eraser"></i> Limpiar
                                        </button>
                                        <span>Dibuje su firma arriba</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="signature-container">
                                    <p>Firma del coordinador/supervisor:</p>
                                    <canvas class="signature-canvas" id="signature-canvas-verbal-supervisor"></canvas>
                                    <div class="signature-controls">
                                        <button type="button" class="btn btn-outline" id="clear-verbal-supervisor">
                                            <i class="fas fa-eraser"></i> Limpiar
                                        </button>
                                        <span>Dibuje su firma arriba</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn btn-outline" id="reset-verbal">
                            <i class="fas fa-redo"></i> Limpiar Formulario
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar Retroalimentación
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Panel de administrador -->
            <div id="admin" class="content admin-only">
                <div class="admin-header">
                    <h2><i class="fas fa-chart-bar"></i> Panel de Administrador</h2>
                    <div>
                        <button class="btn btn-primary" id="refresh-data">
                            <i class="fas fa-sync-alt"></i> Actualizar Datos
                        </button>
                    </div>
                </div>
                
                <div class="admin-controls">
                    <button class="btn btn-primary" id="export-pdf">
                        <i class="fas fa-file-pdf"></i> Exportar PDF General
                    </button>
                    <button class="btn btn-secondary" id="export-excel">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <input type="date" id="filter-date">
                    </div>
                    <button class="btn btn-outline" id="filter-apply">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <button class="btn btn-outline" id="filter-clear">
                        <i class="fas fa-times"></i> Limpiar Filtro
                    </button>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-feedbacks">0</h3>
                            <p>Total retroalimentaciones</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="escritas-count">0</h3>
                            <p>Escritas</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="verbales-count">0</h3>
                            <p>Verbales</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="colaboradores-count">0</h3>
                            <p>Colaboradores con feedback</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <h3 style="margin-bottom: 15px; padding: 15px 15px 0;">Retroalimentaciones Registradas</h3>
                    <table id="feedbacks-table">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>N° Empleado</th>
                                <th>Nombre</th>
                                <th>Supervisor/Coordinador</th>
                                <th>Cuadrilla Líder</th>
                                <th>Cuadrilla Colaborador</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="feedbacks-tbody">
                            <!-- Datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                    <div id="no-data-message" style="padding: 30px; text-align: center; color: #666; display: none;">
                        <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No hay retroalimentaciones registradas todavía.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para exportar PDF individual -->
    <div id="pdf-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-pdf"></i> Exportar Retroalimentación</h2>
                <button class="close-modal" id="close-pdf-modal">&times;</button>
            </div>
            
            <div class="form-section">
                <h3><i class="fas fa-info-circle"></i> Seleccionar retroalimentación</h3>
                
                <div class="form-group">
                    <label for="pdf-feedback-select">Seleccione una retroalimentación:</label>
                    <select id="pdf-feedback-select">
                        <option value="">Cargando retroalimentaciones...</option>
                    </select>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Esta acción generará un PDF con todos los datos y firmas de la retroalimentación seleccionada.</span>
                </div>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn btn-outline" id="cancel-pdf">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="generate-individual-pdf">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
            </div>
        </div>
         
    </div>

    <script>
    // ============================================
    // CONFIGURACIÓN SUPABASE
    // ============================================
    
    const SUPABASE_URL = 'https://mwuxcwpxxryzggsmwibf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dXhjd3B4eHJ5emdnc213aWJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMzg2MTUsImV4cCI6MjA4MjYxNDYxNX0.zGDDD7Ro4rTlHURBYSwg-CEjoxOr82Qmt6naL8nm7a8';
    
    // ============================================
    // CONFIGURACIÓN INICIAL
    // ============================================
    
    const USERS = {
        supervisor: { password: "sup123", name: "Supervisor" },
        admin: { password: "admin123", name: "Administrador" }
    };
    
    let currentUser = null;
    let supabaseClient = null;
    
    const lideres = [
        {id: "1042", nombre: "RODRIGUEZ ALAMILLA JUAN FELIX", rol: "SUPERVISOR", area: "C"},
        {id: "1064", nombre: "CASTILLO RODRIGUEZ SERGIO", rol: "SUPERVISOR SENIOR", area: "C"},
        {id: "1813", nombre: "VILLAGOMEZ RAMIREZ MARIO", rol: "SUPERVISOR", area: "D"},
        {id: "3846", nombre: "BRIOSO PEREZ JESUS GUADALUPE", rol: "SUPERVISOR", area: "A"},
        {id: "4497", nombre: "CORTEZ ACUÑA IGNACIO", rol: "SUPERVISOR SENIOR", area: "B"},
        {id: "73313", nombre: "HERNANDEZ GARDUÑO CARLOS ADRIAN", rol: "GERENTE", area: "GERENCIA"}
    ];
    
    // Variables globales para instancias de canvas
    let canvasInstances = {};

    // ============================================
    // FUNCIONES PARA CANVAS Y FIRMAS (MOVIDAS AL INICIO)
    // ============================================

function initializeCanvas(canvasId, clearBtnId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    
    const ctx = canvas.getContext('2d');
    
    // Configuración inicial optimizada
    canvas.style.touchAction = 'none';
    canvas.style.userSelect = 'none';
    
    // Variables de estado
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let hasSignature = false;
    
    // Configuración inicial del canvas
    function setupCanvas() {
        const parent = canvas.parentElement;
        const rect = parent.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        
        // Establecer dimensiones físicas
        canvas.width = rect.width * dpr;
        canvas.height = 150 * dpr;
        
        // Establecer dimensiones CSS
        canvas.style.width = `${rect.width}px`;
        canvas.style.height = '150px';
        
        // Escalar contexto
        ctx.scale(dpr, dpr);
        
        // Limpiar canvas
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, rect.width, 150);
        
        // Configurar estilo de dibujo
        ctx.strokeStyle = '#333333';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 2.5;
    }
    
    // Inicializar
    setupCanvas();
    
    // Función para obtener coordenadas corregidas
    function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        
        if (e.type.includes('mouse')) {
            clientX = e.clientX;
            clientY = e.clientY;
        } else if (e.type.includes('touch')) {
            e.preventDefault();
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }
        
        // Calcular coordenadas relativas al canvas
        const x = (clientX - rect.left) * (canvas.width / (rect.width * window.devicePixelRatio));
        const y = (clientY - rect.top) * (canvas.height / (150 * window.devicePixelRatio));
        
        return [x, y];
    }
    
    // Eventos para desktop
    function startDrawing(e) {
        isDrawing = true;
        [lastX, lastY] = getCoordinates(e);
        hasSignature = true;
        
        // Dibujar punto inicial
        ctx.beginPath();
        ctx.arc(lastX, lastY, ctx.lineWidth / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        const [x, y] = getCoordinates(e);
        
        ctx.lineTo(x, y);
        ctx.stroke();
        
        [lastX, lastY] = [x, y];
    }
    
    function stopDrawing() {
        if (isDrawing) {
            ctx.beginPath();
            isDrawing = false;
        }
    }
    
    // Event listeners optimizados
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    
    // Eventos táctiles optimizados
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (e.touches.length === 1) {
            startDrawing(e);
        }
    }, { passive: false });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length === 1) {
            draw(e);
        }
    }, { passive: false });
    
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopDrawing();
    }, { passive: false });
    
    canvas.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        stopDrawing();
    }, { passive: false });
    
    // Prevenir scroll en móvil mientras se dibuja
    document.body.addEventListener('touchmove', (e) => {
        if (isDrawing && e.target === canvas) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // Limpiar firma
    const clearBtn = document.getElementById(clearBtnId);
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2.5;
            hasSignature = false;
        });
    }
    
    // Redimensionar en resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            setupCanvas();
        }, 100);
    });
    
    return {
        canvas: canvas,
        hasSignature: () => hasSignature,
        clear: () => {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
        }
    };
}

// Agrega esta función para verificar el soporte táctil
function setupTouchSupport() {
    // Prevenir zoom con dos dedos en canvas
    document.querySelectorAll('.signature-canvas').forEach(canvas => {
        canvas.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
        
        canvas.addEventListener('gesturechange', (e) => {
            e.preventDefault();
        });
        
        canvas.addEventListener('gestureend', (e) => {
            e.preventDefault();
        });
    });
}

// Modifica la función initializeAllCanvas:
function initializeAllCanvas() {
    const canvasConfigs = [
        {id: 'signature-canvas-colaborador', clearBtn: 'clear-colaborador'},
        {id: 'signature-canvas-supervisor', clearBtn: 'clear-supervisor'},
        {id: 'signature-canvas-sindical', clearBtn: 'clear-sindical'},
        {id: 'signature-canvas-rh', clearBtn: 'clear-rh'},
        {id: 'signature-canvas-verbal-colaborador', clearBtn: 'clear-verbal-colaborador'},
        {id: 'signature-canvas-verbal-supervisor', clearBtn: 'clear-verbal-supervisor'}
    ];
    
    // Esperar a que el DOM esté completamente renderizado
    setTimeout(() => {
        canvasConfigs.forEach(config => {
            canvasInstances[config.id] = initializeCanvas(config.id, config.clearBtn);
        });
        
        // Configurar soporte táctil
        setupTouchSupport();
    }, 300);
}

    function initializeAllCanvas() {
        const canvasConfigs = [
            {id: 'signature-canvas-colaborador', clearBtn: 'clear-colaborador', required: true},
            {id: 'signature-canvas-supervisor', clearBtn: 'clear-supervisor', required: true},
            {id: 'signature-canvas-sindical', clearBtn: 'clear-sindical', required: true},
            {id: 'signature-canvas-rh', clearBtn: 'clear-rh', required: true},
            {id: 'signature-canvas-verbal-colaborador', clearBtn: 'clear-verbal-colaborador', required: true},
            {id: 'signature-canvas-verbal-supervisor', clearBtn: 'clear-verbal-supervisor', required: true}
        ];
        
        canvasConfigs.forEach(config => {
            canvasInstances[config.id] = initializeCanvas(config.id, config.clearBtn);
        });
    }

    // ============================================
    // VALIDACIONES MEJORADAS DE FIRMAS
    // ============================================

    function validarFirmasCompletas(formType = 'escrita') {
        const firmasRequeridas = {
            'escrita': [
                'signature-canvas-colaborador',
                'signature-canvas-supervisor',
                'signature-canvas-sindical',
                'signature-canvas-rh'
            ],
            'verbal': [
                'signature-canvas-verbal-colaborador',
                'signature-canvas-verbal-supervisor'
            ]
        };
        
        const canvasIds = firmasRequeridas[formType] || [];
        const firmasFaltantes = [];
        
        canvasIds.forEach(canvasId => {
            const instance = canvasInstances[canvasId];
            if (instance && !instance.hasSignature()) {
                const nombreFirma = canvasId.includes('colaborador') ? 'Colaborador' :
                                  canvasId.includes('supervisor') ? 'Supervisor' :
                                  canvasId.includes('sindical') ? 'Líder Sindical' :
                                  canvasId.includes('rh') ? 'Recursos Humanos' :
                                  'Firma';
                
                firmasFaltantes.push(nombreFirma);
                
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.style.border = '2px solid #CF002E';
                    canvas.style.borderRadius = '8px';
                    
                    setTimeout(() => {
                        canvas.style.border = '1px solid var(--medium-gray)';
                    }, 3000);
                }
            }
        });
        
        return {
            todasCompletas: firmasFaltantes.length === 0,
            firmasFaltantes: firmasFaltantes
        };
    }

    function canvasTieneContenido(canvas) {
        if (!canvas) return false;
        
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            const a = data[i + 3];
            
            if (a > 10 && (r < 250 || g < 250 || b < 250)) {
                return true;
            }
        }
        
        return false;
    }

    function capturarFirmas(formType = 'escrita') {
        const firmas = {};
        
        const firmasConfig = {
            'escrita': [
                {id: 'signature-canvas-colaborador', key: 'colaborador'},
                {id: 'signature-canvas-supervisor', key: 'supervisor'},
                {id: 'signature-canvas-sindical', key: 'sindical'},
                {id: 'signature-canvas-rh', key: 'rh'}
            ],
            'verbal': [
                {id: 'signature-canvas-verbal-colaborador', key: 'colaborador'},
                {id: 'signature-canvas-verbal-supervisor', key: 'supervisor'}
            ]
        };
        
        const config = firmasConfig[formType] || [];
        
        config.forEach(({id, key}) => {
            const canvas = document.getElementById(id);
            if (canvas && canvasTieneContenido(canvas)) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = 400;
                tempCanvas.height = 150;
                
                tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                firmas[key] = tempCanvas.toDataURL('image/png', 0.7);
            }
        });
        
        return firmas;
    }

    // ============================================
    // FUNCIONES AUXILIARES GENERALES
    // ============================================

    function extraerLetraCuadrilla(cuadrilla) {
        if (!cuadrilla) return '';
        
        if (cuadrilla.length === 1) {
            return cuadrilla;
        }
        
        const match = cuadrilla.match(/[A-Za-z]$/);
        return match ? match[0] : cuadrilla;
    }

    function showTab(tabId) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const activeTab = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
        if (activeTab) activeTab.classList.add('active');
        
        document.querySelectorAll('.content').forEach(content => {
            content.classList.add('hidden');
        });
        
        document.getElementById(tabId).classList.remove('hidden');
        
        setTimeout(() => {
            initializeAllCanvas();
        }, 100);
    }

    function aplicarFiltro() {
        const fecha = document.getElementById('filter-date').value;
        if (!fecha) {
            alert('Por favor seleccione una fecha');
            return;
        }
        actualizarTablaFeedbacks(fecha);
    }

    function limpiarFiltro() {
        document.getElementById('filter-date').value = new Date().toISOString().split('T')[0];
        actualizarTablaFeedbacks();
    }

    // ============================================
    // FUNCIONES PARA MODAL PDF INDIVIDUAL
    // ============================================

    function openPdfModal() {
        document.getElementById('pdf-modal').style.display = 'block';
        cargarFeedbacksParaPDF();
    }

    function closePdfModal() {
        document.getElementById('pdf-modal').style.display = 'none';
    }

    // ============================================
    // INICIALIZACIÓN SUPABASE
    // ============================================

    function initializeSupabase() {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = function() {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase inicializado');
            }
        };
        document.head.appendChild(script);
    }

    // ============================================
    // FUNCIONES DE INICIALIZACIÓN Y CONFIGURACIÓN
    // ============================================

    function showApp() {
        document.getElementById('app').classList.remove('hidden');
    }

    function setupAreaOtroValidations() {
        // Configurar área "Otro" para formulario escrito
        document.getElementById('area').addEventListener('change', function() {
            const areaOtroContainer = document.getElementById('area-otro-container');
            if (this.value === 'Otro') {
                areaOtroContainer.classList.remove('hidden');
                document.getElementById('area-otro').required = true;
            } else {
                areaOtroContainer.classList.add('hidden');
                document.getElementById('area-otro').required = false;
            }
        });
        
        // Configurar área "Otro" para formulario verbal
        document.getElementById('area-verbal').addEventListener('change', function() {
            const areaVerbalOtroContainer = document.getElementById('area-verbal-otro-container');
            if (this.value === 'Otro') {
                areaVerbalOtroContainer.classList.remove('hidden');
                document.getElementById('area-verbal-otro').required = true;
            } else {
                areaVerbalOtroContainer.classList.add('hidden');
                document.getElementById('area-verbal-otro').required = false;
            }
        });
    }

    function setupLiderOtroValidations() {
        // Configurar líder "Otro" para formulario escrito
        document.getElementById('lider').addEventListener('change', function() {
            const liderOtroContainer = document.getElementById('lider-otro-container');
            if (this.value === 'otro') {
                liderOtroContainer.classList.remove('hidden');
                document.getElementById('lider-otro-nombre').required = true;
                document.getElementById('lider-otro-puesto').required = true;
                document.getElementById('lider-otro-area').required = true;
            } else {
                liderOtroContainer.classList.add('hidden');
                document.getElementById('lider-otro-nombre').required = false;
                document.getElementById('lider-otro-puesto').required = false;
                document.getElementById('lider-otro-area').required = false;
            }
        });
        
        // Configurar líder "Otro" para formulario verbal
        document.getElementById('lider-verbal').addEventListener('change', function() {
            const liderVerbalOtroContainer = document.getElementById('lider-verbal-otro-container');
            if (this.value === 'otro') {
                liderVerbalOtroContainer.classList.remove('hidden');
                document.getElementById('lider-verbal-otro-nombre').required = true;
                document.getElementById('lider-verbal-otro-puesto').required = true;
                document.getElementById('lider-verbal-otro-area').required = true;
            } else {
                liderVerbalOtroContainer.classList.add('hidden');
                document.getElementById('lider-verbal-otro-nombre').required = false;
                document.getElementById('lider-verbal-otro-puesto').required = false;
                document.getElementById('lider-verbal-otro-area').required = false;
            }
        });
    }

    function setupEventListeners() {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                showTab(tabId);
            });
        });
        
        document.getElementById('formEscrita').addEventListener('submit', submitFormEscrita);
        document.getElementById('formVerbal').addEventListener('submit', submitFormVerbal);
        
        document.getElementById('reset-escrita').addEventListener('click', resetFormEscrita);
        document.getElementById('reset-verbal').addEventListener('click', resetFormVerbal);
        
        document.getElementById('export-excel').addEventListener('click', exportExcel);
        document.getElementById('export-pdf').addEventListener('click', exportGeneralPDF);
        document.getElementById('refresh-data').addEventListener('click', actualizarDashboard);
        document.getElementById('filter-apply').addEventListener('click', aplicarFiltro);
        document.getElementById('filter-clear').addEventListener('click', limpiarFiltro);
        
        document.getElementById('btn-logout').addEventListener('click', function() {
            if (confirm('¿Está seguro que desea salir?')) {
                location.reload();
            }
        });
        
        // Configurar validaciones de campos "Otro"
        setupAreaOtroValidations();
        setupLiderOtroValidations();
        
        document.getElementById('num-empleado').addEventListener('input', function() {
            const seccionColaborador = document.getElementById('seccion-colaborador');
            if (this.value) {
                seccionColaborador.classList.remove('hidden');
            } else {
                seccionColaborador.classList.add('hidden');
            }
        });
        
        document.getElementById('image-upload-area').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });
        
        document.getElementById('image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Eventos para modal PDF individual
        document.getElementById('close-pdf-modal').addEventListener('click', closePdfModal);
        document.getElementById('cancel-pdf').addEventListener('click', closePdfModal);
        document.getElementById('generate-individual-pdf').addEventListener('click', generateIndividualPDF);
    }

    function cargarLideres() {
        const selectEscrito = document.getElementById('lider');
        const selectVerbal = document.getElementById('lider-verbal');
        
        selectEscrito.innerHTML = '<option value="">Seleccionar líder</option>';
        selectVerbal.innerHTML = '<option value="">Seleccionar líder</option>';
        
        lideres.forEach(lider => {
            const option1 = document.createElement('option');
            option1.value = lider.id;
            option1.textContent = `${lider.nombre} - ${lider.rol} (${lider.area})`;
            selectEscrito.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = lider.id;
            option2.textContent = `${lider.nombre} - ${lider.rol} (${lider.area})`;
            selectVerbal.appendChild(option2);
        });
        
        const otroOption1 = document.createElement('option');
        otroOption1.value = 'otro';
        otroOption1.textContent = 'Otro (especificar en los campos siguientes)';
        selectEscrito.appendChild(otroOption1);
        
        const otroOption2 = document.createElement('option');
        otroOption2.value = 'otro';
        otroOption2.textContent = 'Otro (especificar en los campos siguientes)';
        selectVerbal.appendChild(otroOption2);
    }

    async function generarFoliosIniciales() {
        try {
            const { data: ultimaEscrita } = await supabaseClient
                .from('retroalimentaciones_escritas')
                .select('folio')
                .order('id', { ascending: false })
                .limit(1)
                .single();
            
            let nextEscrita = 1;
            if (ultimaEscrita && ultimaEscrita.folio) {
                const matches = ultimaEscrita.folio.match(/ESC-2526-(\d+)/);
                if (matches) {
                    nextEscrita = parseInt(matches[1]) + 1;
                }
            }
            
            const { data: ultimaVerbal } = await supabaseClient
                .from('retroalimentaciones_verbales')
                .select('folio')
                .order('id', { ascending: false })
                .limit(1)
                .single();
            
            let nextVerbal = 1;
            if (ultimaVerbal && ultimaVerbal.folio) {
                const matches = ultimaVerbal.folio.match(/VER-2526-(\d+)/);
                if (matches) {
                    nextVerbal = parseInt(matches[1]) + 1;
                }
            }
            
            document.getElementById('folio-escrita').value = `ESC-2526-${String(nextEscrita).padStart(6, '0')}`;
            document.getElementById('folio-verbal').value = `VER-2526-${String(nextVerbal).padStart(6, '0')}`;
            
        } catch (error) {
            document.getElementById('folio-escrita').value = 'ESC-2526-000001';
            document.getElementById('folio-verbal').value = 'VER-2526-000001';
        }
    }

    function actualizarFechas() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-escrita').value = today;
        document.getElementById('fecha-verbal').value = today;
        document.getElementById('filter-date').value = today;
        
        generarFoliosIniciales();
    }

    // ============================================
    // AUTENTICACIÓN
    // ============================================

    function handleLogin() {
        const role = document.getElementById('user-role').value;
        const password = document.getElementById('user-password').value;
        const errorMsg = document.getElementById('login-error');
        
        if (!role || !password) {
            errorMsg.querySelector('span').textContent = 'Por favor complete todos los campos';
            errorMsg.classList.remove('hidden');
            return;
        }
        
        if (USERS[role] && USERS[role].password === password) {
            currentUser = {
                username: role,
                role: role,
                name: USERS[role].name
            };
            
            document.getElementById('login-screen').classList.add('hidden');
            showApp();
            
            document.getElementById('user-role-display').textContent = USERS[role].name;
            
            if (role === 'admin') {
                document.querySelectorAll('.supervisor-only').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                showTab('admin');
                actualizarDashboard();
            } else {
                document.querySelectorAll('.supervisor-only').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                showTab('form-escrita');
                generarFoliosIniciales();
            }
        } else {
            errorMsg.querySelector('span').textContent = 'Credenciales incorrectas. Intente nuevamente.';
            errorMsg.classList.remove('hidden');
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').focus();
        }
    }

    // ============================================
    // MANEJO DE FORMULARIOS CON SUPABASE
    // ============================================

    async function submitFormEscrita(e) {
        e.preventDefault();
        
        // Validar firmas antes de proceder
        const validacionFirmas = validarFirmasCompletas('escrita');
        if (!validacionFirmas.todasCompletas) {
            alert(`❌ Faltan las siguientes firmas:\n\n${validacionFirmas.firmasFaltantes.join('\n')}\n\nPor favor complete todas las firmas requeridas.`);
            
            const primerCanvasId = validacionFirmas.firmasFaltantes[0];
            const canvasMap = {
                'Colaborador': 'signature-canvas-colaborador',
                'Supervisor': 'signature-canvas-supervisor',
                'Líder Sindical': 'signature-canvas-sindical',
                'Recursos Humanos': 'signature-canvas-rh'
            };
            
            const canvasId = canvasMap[primerCanvasId];
            if (canvasId) {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            return;
        }
        
        const areaSelect = document.getElementById('area').value;
        let area = areaSelect;
        
        if (areaSelect === 'Otro') {
            area = document.getElementById('area-otro').value;
            if (!area) {
                alert('Por favor especifique el área cuando selecciona "Otro"');
                return;
            }
        }
        
        const liderSelect = document.getElementById('lider').value;
        let liderNombre = '';
        let liderInfo = {};
        
        if (liderSelect === 'otro') {
            const nombre = document.getElementById('lider-otro-nombre').value;
            const puesto = document.getElementById('lider-otro-puesto').value;
            const areaLider = document.getElementById('lider-otro-area').value;
            
            if (!nombre || !puesto || !areaLider) {
                alert('Por favor complete todos los campos del líder cuando selecciona "Otro"');
                return;
            }
            
            liderNombre = `${nombre} - ${puesto} (${areaLider})`;
            liderInfo = {
                id: 'otro',
                nombre: nombre,
                puesto: puesto,
                area: areaLider
            };
        } else {
            const liderSeleccionado = lideres.find(l => l.id === liderSelect);
            if (liderSeleccionado) {
                liderNombre = `${liderSeleccionado.nombre} - ${liderSeleccionado.rol} (${liderSeleccionado.area})`;
                liderInfo = liderSeleccionado;
            }
        }
        
        const cuadrillaLider = document.getElementById('cuadrilla-lider').value;
        const nombreColaborador = document.getElementById('nombre-colaborador').value;
        const cuadrillaColaborador = document.getElementById('cuadrilla-colaborador').value;
        const numEmpleado = document.getElementById('num-empleado').value;
        const descripcionImpacto = document.getElementById('descripcion-impacto').value;
        const compromiso = document.getElementById('compromiso').value;
        
        const checkboxesImpacto = document.querySelectorAll('input[name="impacto"]:checked');
        if (checkboxesImpacto.length === 0) {
            alert('Por favor seleccione al menos un tipo de impacto');
            return;
        }
        
        let causas = [];
        let explicacionCausa = '';
        let accionDiferente = '';
        
        const seccionColaborador = document.getElementById('seccion-colaborador');
        if (!seccionColaborador.classList.contains('hidden')) {
            const checkboxesCausa = document.querySelectorAll('input[name="causa-problema"]:checked');
            if (checkboxesCausa.length === 0) {
                alert('Por favor seleccione al menos una causa del problema en la sección del colaborador');
                return;
            }
            
            causas = Array.from(checkboxesCausa).map(cb => cb.value);
            explicacionCausa = document.getElementById('explicacion-causa-colaborador').value;
            accionDiferente = document.getElementById('accion-diferente').value;
        }
        
        if (!area || !liderSelect || !cuadrillaLider || !nombreColaborador || !cuadrillaColaborador || !numEmpleado || !descripcionImpacto || !compromiso) {
            alert('Por favor complete todos los campos requeridos (*)');
            return;
        }
        
        const firmas = capturarFirmas('escrita');
        
        const feedbackData = {
            folio: document.getElementById('folio-escrita').value,
            fecha: document.getElementById('fecha-escrita').value,
            tipo_feedback: document.querySelector('input[name="tipo-feedback-escrita"]:checked').value,
            area: area,
            lider_id: liderSelect,
            lider_nombre: liderNombre,
            lider_info: liderInfo,
            cuadrilla_lider: cuadrillaLider,
            nombre_colaborador: nombreColaborador,
            cuadrilla_colaborador: cuadrillaColaborador,
            num_empleado: parseInt(numEmpleado),
            impactos: Array.from(checkboxesImpacto).map(cb => cb.value),
            descripcion_impacto: descripcionImpacto,
            causas: causas,
            explicacion_causa: explicacionCausa || null,
            accion_diferente: accionDiferente || null,
            compromiso: compromiso,
            firmas: firmas,
            usuario: currentUser ? currentUser.username : 'anónimo'
        };
        
        try {
            const { data, error } = await supabaseClient
                .from('retroalimentaciones_escritas')
                .insert([feedbackData]);
            
            if (error) throw error;
            
            alert('✅ Retroalimentación guardada exitosamente');
            resetFormEscrita();
            generarFoliosIniciales();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar: ' + error.message);
        }
    }

    async function submitFormVerbal(e) {
        e.preventDefault();
        
        const areaVerbalSelect = document.getElementById('area-verbal').value;
        let areaVerbal = areaVerbalSelect;
        
        if (areaVerbalSelect === 'Otro') {
            areaVerbal = document.getElementById('area-verbal-otro').value;
            if (!areaVerbal) {
                alert('Por favor especifique el área cuando selecciona "Otro"');
                return;
            }
        }
        
        const liderSelect = document.getElementById('lider-verbal').value;
        let liderNombre = '';
        let liderInfo = {};
        
        if (liderSelect === 'otro') {
            const nombre = document.getElementById('lider-verbal-otro-nombre').value;
            const puesto = document.getElementById('lider-verbal-otro-puesto').value;
            const areaLider = document.getElementById('lider-verbal-otro-area').value;
            
            if (!nombre || !puesto || !areaLider) {
                alert('Por favor complete todos los campos del líder cuando selecciona "Otro"');
                return;
            }
            
            liderNombre = `${nombre} - ${puesto} (${areaLider})`;
            liderInfo = {
                id: 'otro',
                nombre: nombre,
                puesto: puesto,
                area: areaLider
            };
        } else {
            const liderSeleccionado = lideres.find(l => l.id === liderSelect);
            if (liderSeleccionado) {
                liderNombre = `${liderSeleccionado.nombre} - ${liderSeleccionado.rol} (${liderSeleccionado.area})`;
                liderInfo = liderSeleccionado;
            }
        }
        
        const cuadrillaLider = document.getElementById('cuadrilla-lider-verbal').value;
        const nombreColaborador = document.getElementById('nombre-colaborador-verbal').value;
        const cuadrillaColaborador = document.getElementById('cuadrilla-verbal-colaborador').value;
        const numEmpleado = document.getElementById('num-empleado-verbal').value;
        const razon = document.getElementById('razon-verbal').value;
        
        if (!liderSelect || !cuadrillaLider || !nombreColaborador || !cuadrillaColaborador || !numEmpleado || !razon || !areaVerbal) {
            alert('Por favor complete todos los campos requeridos (*)');
            return;
        }
        
        let imagenBase64 = null;
        const preview = document.getElementById('image-preview');
        if (preview.style.display === 'block') {
            imagenBase64 = preview.src;
        }
        
        const firmas = capturarFirmas('verbal');
        
        const feedbackData = {
            folio: document.getElementById('folio-verbal').value,
            fecha: document.getElementById('fecha-verbal').value,
            area: areaVerbal,
            lider_id: liderSelect,
            lider_nombre: liderNombre,
            lider_info: liderInfo,
            cuadrilla_lider: cuadrillaLider,
            nombre_colaborador: nombreColaborador,
            cuadrilla_colaborador: cuadrillaColaborador,
            num_empleado: parseInt(numEmpleado),
            razon: razon,
            imagen: imagenBase64,
            firmas: firmas,
            usuario: currentUser ? currentUser.username : 'anónimo'
        };
        
        try {
            const { data, error } = await supabaseClient
                .from('retroalimentaciones_verbales')
                .insert([feedbackData]);
            
            if (error) throw error;
            
            alert('✅ Retroalimentación verbal guardada exitosamente');
            resetFormVerbal();
            generarFoliosIniciales();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar: ' + error.message);
        }
    }

    // ============================================
    // FUNCIONES DE RESET DE FORMULARIOS
    // ============================================

    function resetFormEscrita() {
        document.getElementById('formEscrita').reset();
        document.getElementById('seccion-colaborador').classList.add('hidden');
        document.getElementById('area-otro-container').classList.add('hidden');
        document.getElementById('area-otro').required = false;
        document.getElementById('lider-otro-container').classList.add('hidden');
        
        const canvases = ['signature-canvas-colaborador', 'signature-canvas-supervisor', 
                         'signature-canvas-sindical', 'signature-canvas-rh'];
        canvases.forEach(canvasId => {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        });
        
        generarFoliosIniciales();
    }

    function resetFormVerbal() {
        document.getElementById('formVerbal').reset();
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('lider-verbal-otro-container').classList.add('hidden');
        document.getElementById('area-verbal-otro-container').classList.add('hidden');
        document.getElementById('area-verbal-otro').required = false;
        
        const canvases = ['signature-canvas-verbal-colaborador', 'signature-canvas-verbal-supervisor'];
        canvases.forEach(canvasId => {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        });
        
        generarFoliosIniciales();
    }

    // ============================================
    // PANEL DE ADMINISTRADOR
    // ============================================

    async function actualizarDashboard() {
        try {
            const { data: escritas } = await supabaseClient
                .from('retroalimentaciones_escritas')
                .select('id, num_empleado');
            
            const { data: verbales } = await supabaseClient
                .from('retroalimentaciones_verbales')
                .select('id, num_empleado');
            
            const totalEscritas = escritas ? escritas.length : 0;
            const totalVerbales = verbales ? verbales.length : 0;
            const total = totalEscritas + totalVerbales;
            
            const empleadosSet = new Set();
            if (escritas) escritas.forEach(e => empleadosSet.add(e.num_empleado));
            if (verbales) verbales.forEach(e => empleadosSet.add(e.num_empleado));
            
            document.getElementById('total-feedbacks').textContent = total;
            document.getElementById('escritas-count').textContent = totalEscritas;
            document.getElementById('verbales-count').textContent = totalVerbales;
            document.getElementById('colaboradores-count').textContent = empleadosSet.size;
            
            await actualizarTablaFeedbacks();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando datos: ' + error.message);
        }
    }

    async function actualizarTablaFeedbacks(filtroFecha = null) {
        try {
            let queryEscritas = supabaseClient
                .from('retroalimentaciones_escritas')
                .select('*');
            
            let queryVerbales = supabaseClient
                .from('retroalimentaciones_verbales')
                .select('*');
            
            if (filtroFecha) {
                queryEscritas = queryEscritas.eq('fecha', filtroFecha);
                queryVerbales = queryVerbales.eq('fecha', filtroFecha);
            }
            
            const { data: escritas } = await queryEscritas.order('creado_en', { ascending: false });
            const { data: verbales } = await queryVerbales.order('creado_en', { ascending: false });
            
            const tbody = document.getElementById('feedbacks-tbody');
            const noDataMsg = document.getElementById('no-data-message');
            
            tbody.innerHTML = '';
            
            const allFeedbacks = [];
            
            if (escritas) {
                escritas.forEach(item => {
                    allFeedbacks.push({
                        ...item,
                        tipo: 'Escrita'
                    });
                });
            }
            
            if (verbales) {
                verbales.forEach(item => {
                    allFeedbacks.push({
                        ...item,
                        tipo: 'Verbal',
                        area_display: item.area || 'N/A'
                    });
                });
            }
            
            if (allFeedbacks.length === 0) {
                noDataMsg.style.display = 'block';
                tbody.style.display = 'none';
                return;
            }
            
            noDataMsg.style.display = 'none';
            tbody.style.display = '';
            
            allFeedbacks.sort((a, b) => new Date(b.creado_en) - new Date(a.creado_en));
            
            allFeedbacks.forEach(feedback => {
                const row = document.createElement('tr');
                
                const tdFolio = document.createElement('td');
                tdFolio.textContent = feedback.folio;
                row.appendChild(tdFolio);
                
                const tdFecha = document.createElement('td');
                tdFecha.textContent = feedback.fecha;
                row.appendChild(tdFecha);
                
                const tdTipo = document.createElement('td');
                if (feedback.tipo === 'Escrita') {
                    tdTipo.innerHTML = `<span class="badge badge-escrita">${feedback.tipo} (${feedback.tipo_feedback})</span>`;
                } else {
                    tdTipo.innerHTML = `<span class="badge badge-verbal">${feedback.tipo}</span>`;
                }
                row.appendChild(tdTipo);
                
                const tdEmpleado = document.createElement('td');
                tdEmpleado.textContent = feedback.num_empleado || 'N/A';
                row.appendChild(tdEmpleado);
                
                const tdNombre = document.createElement('td');
                tdNombre.textContent = feedback.nombre_colaborador || 'N/A';
                row.appendChild(tdNombre);

                const tdArea = document.createElement('td');
                tdArea.textContent = feedback.area_display || 'N/A';
                row.appendChild(tdArea);
                
                const tdSupervisor = document.createElement('td');
                tdSupervisor.textContent = feedback.lider_nombre ? 
                    feedback.lider_nombre.split(' - ')[0] : 
                    'N/A';
                row.appendChild(tdSupervisor);
                
                const tdCuadrillaLider = document.createElement('td');
                tdCuadrillaLider.textContent = feedback.cuadrilla_lider || 'N/A';
                row.appendChild(tdCuadrillaLider);
                
                const tdCuadrillaColaborador = document.createElement('td');
                tdCuadrillaColaborador.textContent = feedback.cuadrilla_colaborador || 'N/A';
                row.appendChild(tdCuadrillaColaborador);
                
                const tdAcciones = document.createElement('td');
                const btnVer = document.createElement('button');
                btnVer.className = 'btn btn-outline';
                btnVer.style.cssText = 'padding: 5px 10px; font-size: 14px;';
                btnVer.innerHTML = '<i class="fas fa-eye"></i>';
                btnVer.title = 'Ver detalles';
                btnVer.addEventListener('click', () => verFeedback(feedback));
                tdAcciones.appendChild(btnVer);
                
                const btnPDF = document.createElement('button');
                btnPDF.className = 'btn btn-primary';
                btnPDF.style.cssText = 'padding: 5px 10px; font-size: 14px; margin-left: 5px;';
                btnPDF.innerHTML = '<i class="fas fa-file-pdf"></i>';
                btnPDF.title = 'Generar PDF';
                btnPDF.addEventListener('click', () => generatePDF(feedback.id, feedback.tipo));
                tdAcciones.appendChild(btnPDF);
                
                row.appendChild(tdAcciones);
                
                tbody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error cargando tabla:', error);
            alert('Error cargando la tabla: ' + error.message);
        }
    }

    function verFeedback(feedback) {
        let detalles = `=== DETALLES DE RETROALIMENTACIÓN ===\n\n`;
        detalles += `Folio: ${feedback.folio}\n`;
        detalles += `Fecha: ${feedback.fecha}\n`;
        detalles += `Tipo: ${feedback.tipo}\n`;
        
        if (feedback.tipo === 'Escrita') {
            detalles += `Subtipo: ${feedback.tipo_feedback}\n`;
            detalles += `Área: ${feedback.area}\n`;
            detalles += `Colaborador: ${feedback.nombre_colaborador || 'N/A'}\n`;
            detalles += `Supervisor: ${feedback.lider_nombre}\n`;
            detalles += `Cuadrilla Líder: ${feedback.cuadrilla_lider || 'N/A'}\n`;
            detalles += `N° Empleado: ${feedback.num_empleado}\n`;
            detalles += `Cuadrilla Colaborador: ${feedback.cuadrilla_colaborador}\n`;
            detalles += `\nImpactos identificados:\n`;
            detalles += feedback.impactos ? `- ${feedback.impactos.join('\n- ')}\n` : 'N/A\n';
            detalles += `\nDescripción del impacto:\n${feedback.descripcion_impacto}\n`;
            
            if (feedback.causas && feedback.causas.length > 0) {
                detalles += `\nCausas identificadas por el colaborador:\n`;
                detalles += `- ${feedback.causas.join('\n- ')}\n`;
            }
            
            detalles += `\nCompromiso del colaborador:\n${feedback.compromiso}\n`;
        } else {
            detalles += `\nColaborador: ${feedback.nombre_colaborador || 'N/A'}\n`;
            detalles += `Supervisor: ${feedback.lider_nombre}\n`;
            detalles += `Cuadrilla Líder: ${feedback.cuadrilla_lider || 'N/A'}\n`;
            detalles += `N° Empleado: ${feedback.num_empleado}\n`;
            detalles += `Cuadrilla Colaborador: ${feedback.cuadrilla_colaborador}\n`;
            detalles += `Área: ${feedback.area || 'N/A'}\n`;
            detalles += `\nRazón:\n${feedback.razon}\n`;
        }
        
        detalles += `\nRegistrado: ${new Date(feedback.creado_en).toLocaleString()}`;
        
        alert(detalles);
    }

    // ============================================
    // FUNCIONES DE EXPORTACIÓN
    // ============================================

    async function exportExcel() {
        try {
            const { data: escritas } = await supabaseClient
                .from('retroalimentaciones_escritas')
                .select('*')
                .order('fecha', { ascending: false });
            
            const { data: verbales } = await supabaseClient
                .from('retroalimentaciones_verbales')
                .select('*')
                .order('fecha', { ascending: false });
            
            if ((!escritas || escritas.length === 0) && (!verbales || verbales.length === 0)) {
                alert('No hay datos para exportar');
                return;
            }
            
            const datosProcesados = [];
            const conteoEmpleados = {};
            
            if (escritas) {
                escritas.forEach(item => {
                    const numEmpleado = item.num_empleado;
                    if (!conteoEmpleados[numEmpleado]) {
                        conteoEmpleados[numEmpleado] = {
                            motivacion: 0,
                            desarrollo: 0,
                            verbal: 0,
                            total: 0
                        };
                    }
                    
                    if (item.tipo_feedback === 'Motivación') {
                        conteoEmpleados[numEmpleado].motivacion++;
                    } else if (item.tipo_feedback === 'Desarrollo') {
                        conteoEmpleados[numEmpleado].desarrollo++;
                    }
                    conteoEmpleados[numEmpleado].total++;
                    
                    datosProcesados.push({
                        'N.Empleado': item.num_empleado,
                        'Nombre': item.nombre_colaborador || 'N/A',
                        '#Retros': conteoEmpleados[numEmpleado].total,
                        'Líder que retroalimenta': item.lider_nombre?.split(' - ')[0] || 'N/A',
                        'Cuadrilla colaborador': extraerLetraCuadrilla(item.cuadrilla_colaborador) || 'N/A',
                        'Cuadrilla líder': extraerLetraCuadrilla(item.cuadrilla_lider) || 'N/A',
                        'Motivación': conteoEmpleados[numEmpleado].motivacion,
                        'Desarrollo': conteoEmpleados[numEmpleado].desarrollo,
                        'Verbal': 0,
                        'Tipo': 'Escrita',
                        'Folio': item.folio,
                        'Fecha': item.fecha,
                        'Área': item.area || 'N/A'
                    });
                });
            }
            
            if (verbales) {
                verbales.forEach(item => {
                    const numEmpleado = item.num_empleado;
                    if (!conteoEmpleados[numEmpleado]) {
                        conteoEmpleados[numEmpleado] = {
                            motivacion: 0,
                            desarrollo: 0,
                            verbal: 0,
                            total: 0
                        };
                    }
                    
                    conteoEmpleados[numEmpleado].verbal++;
                    conteoEmpleados[numEmpleado].total++;
                    
                    const registroExistente = datosProcesados.find(d => d['N.Empleado'] === numEmpleado);
                    if (registroExistente) {
                        registroExistente['#Retros'] = conteoEmpleados[numEmpleado].total;
                        registroExistente['Verbal'] = conteoEmpleados[numEmpleado].verbal;
                    } else {
                        datosProcesados.push({
                            'N.Empleado': item.num_empleado,
                            'Nombre': item.nombre_colaborador || 'N/A',
                            '#Retros': conteoEmpleados[numEmpleado].total,
                            'Líder que retroalimenta': item.lider_nombre?.split(' - ')[0] || 'N/A',
                            'Cuadrilla colaborador': extraerLetraCuadrilla(item.cuadrilla_colaborador) || 'N/A',
                            'Cuadrilla líder': extraerLetraCuadrilla(item.cuadrilla_lider) || 'N/A',
                            'Motivación': 0,
                            'Desarrollo': 0,
                            'Verbal': conteoEmpleados[numEmpleado].verbal,
                            'Tipo': 'Verbal',
                            'Folio': item.folio,
                            'Fecha': item.fecha,
                            'Área': item.area || 'N/A'
                        });
                    }
                });
            }
            
            const datosConsolidados = [];
            const empleadosUnicos = [...new Set(datosProcesados.map(d => d['N.Empleado']))];
            
            empleadosUnicos.forEach(numEmpleado => {
                const registrosEmpleado = datosProcesados.filter(d => d['N.Empleado'] === numEmpleado);
                const ultimoRegistro = registrosEmpleado[0];
                
                datosConsolidados.push({
                    'N.Empleado': numEmpleado,
                    'Nombre': ultimoRegistro.Nombre,
                    '#Retros': conteoEmpleados[numEmpleado].total,
                    'Líder que retroalimenta': ultimoRegistro['Líder que retroalimenta'],
                    'Cuadrilla colaborador': ultimoRegistro['Cuadrilla colaborador'],
                    'Cuadrilla líder': ultimoRegistro['Cuadrilla líder'],
                    'Motivación': conteoEmpleados[numEmpleado].motivacion,
                    'Desarrollo': conteoEmpleados[numEmpleado].desarrollo,
                    'Verbal': conteoEmpleados[numEmpleado].verbal
                });
            });
            
            const wb = XLSX.utils.book_new();
            
            const ws1 = XLSX.utils.json_to_sheet(datosConsolidados);
            XLSX.utils.book_append_sheet(wb, ws1, "Resumen por Empleado");
            
            if (escritas && escritas.length > 0) {
                const escritasSimplificadas = escritas.map(item => ({
                    'Folio': item.folio,
                    'Fecha': item.fecha,
                    'N.Empleado': item.num_empleado,
                    'Nombre': item.nombre_colaborador || 'N/A',
                    'Tipo Feedback': item.tipo_feedback,
                    'Líder': item.lider_nombre,
                    'Cuadrilla Líder': extraerLetraCuadrilla(item.cuadrilla_lider) || 'N/A',
                    'Cuadrilla Colaborador': extraerLetraCuadrilla(item.cuadrilla_colaborador) || 'N/A',
                    'Área': item.area,
                    'Impactos': item.impactos?.join(', '),
                    'Descripción': item.descripcion_impacto
                }));
                const ws2 = XLSX.utils.json_to_sheet(escritasSimplificadas);
                XLSX.utils.book_append_sheet(wb, ws2, "Retroalimentaciones Escritas");
            }
            
            if (verbales && verbales.length > 0) {
                const verbalesSimplificadas = verbales.map(item => ({
                    'Folio': item.folio,
                    'Fecha': item.fecha,
                    'N.Empleado': item.num_empleado,
                    'Nombre': item.nombre_colaborador || 'N/A',
                    'Líder': item.lider_nombre,
                    'Cuadrilla Líder': extraerLetraCuadrilla(item.cuadrilla_lider) || 'N/A',
                    'Cuadrilla Colaborador': extraerLetraCuadrilla(item.cuadrilla_colaborador) || 'N/A',
                    'Área': item.area || 'N/A',
                    'Razón': item.razon
                }));
                const ws3 = XLSX.utils.json_to_sheet(verbalesSimplificadas);
                XLSX.utils.book_append_sheet(wb, ws3, "Retroalimentaciones Verbales");
            }
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Reporte_Retroalimentaciones_${fecha}.xlsx`);
            
            alert('✅ Archivo Excel generado exitosamente');
            
        } catch (error) {
            console.error('Error exportando Excel:', error);
            alert('Error al exportar: ' + error.message);
        }
    }

  async function generatePDF(feedbackId, tipo) {
        try {
            let feedback;
            
            if (tipo === 'Escrita') {
                const { data } = await supabaseClient
                    .from('retroalimentaciones_escritas')
                    .select('*')
                    .eq('id', feedbackId)
                    .single();
                feedback = data;
            } else {
                const { data } = await supabaseClient
                    .from('retroalimentaciones_verbales')
                    .select('*')
                    .eq('id', feedbackId)
                    .single();
                feedback = data;
            }
            
            if (!feedback) {
                alert('No se encontró la retroalimentación');
                return;
            }
            
            function extraerNombreLider(liderNombreCompleto) {
                if (!liderNombreCompleto) return 'N/A';
                const partes = liderNombreCompleto.split(' - ');
                return partes[0];
            }
            
            const nombreLider = extraerNombreLider(feedback.lider_nombre);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const primaryColor = [207, 0, 46];
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            let yPos = margin;
            
            // ============ ENCABEZADO ============
            doc.setFontSize(20);
            doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.text('FORMULARIO DE RETROALIMENTACIÓN', pageWidth / 2, yPos, null, null, 'center');
            yPos += 15;
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Folio: ${feedback.folio}`, margin, yPos);
            doc.text(`Fecha: ${feedback.fecha}`, pageWidth - margin - 40, yPos);
            yPos += 8;
            
            doc.text(`Tipo: ${tipo}`, margin, yPos);
            if (tipo === 'Escrita') {
                doc.text(`Subtipo: ${feedback.tipo_feedback}`, pageWidth - margin - 40, yPos);
            } else {
                doc.text(`Área: ${feedback.area || 'N/A'}`, pageWidth - margin - 40, yPos);
            }
            yPos += 15;
            
            // ============ INFORMACIÓN GENERAL ============
            if (tipo === 'Escrita') {
                doc.setFontSize(14);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('INFORMACIÓN GENERAL', margin, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Área: ${feedback.area || 'N/A'}`, margin, yPos);
                yPos += 8;
            }
            
            // ============ LÍDER Y COLABORADOR ============
            doc.setFontSize(14);
            doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.text('INFORMACIÓN DEL LÍDER Y COLABORADOR', margin, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            // Columna izquierda
            doc.text(`Líder: ${nombreLider}`, margin, yPos);
            doc.text(`Cuadrilla Líder: ${feedback.cuadrilla_lider || 'N/A'}`, margin, yPos + 8);
            doc.text(`Colaborador: ${feedback.nombre_colaborador || 'N/A'}`, margin, yPos + 16);
            
            // Columna derecha
            doc.text(`N° Empleado: ${feedback.num_empleado || 'N/A'}`, pageWidth / 2, yPos);
            doc.text(`Cuadrilla Colaborador: ${feedback.cuadrilla_colaborador || 'N/A'}`, pageWidth / 2, yPos + 8);
            
            yPos += 30;
            
            // ============ DETALLES ============
            doc.setFontSize(14);
            doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            
            if (tipo === 'Escrita') {
                doc.text('DETALLES DE LA RETROALIMENTACIÓN', margin, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                // Impactos
                let impactosTexto = 'Impactos identificados: ';
                if (feedback.impactos && feedback.impactos.length > 0) {
                    impactosTexto += feedback.impactos.join(', ');
                } else {
                    impactosTexto += 'N/A';
                }
                
                const impactosLines = doc.splitTextToSize(impactosTexto, pageWidth - 2 * margin);
                doc.text(impactosLines, margin, yPos);
                yPos += impactosLines.length * 7 + 5;
                
                // Descripción
                const descripcionTexto = `Descripción: ${feedback.descripcion_impacto || 'N/A'}`;
                const descripcionLines = doc.splitTextToSize(descripcionTexto, pageWidth - 2 * margin);
                doc.text(descripcionLines, margin, yPos);
                yPos += descripcionLines.length * 7 + 5;
                
                // Causas
                if (feedback.causas && feedback.causas.length > 0) {
                    let causasTexto = 'Causas identificadas: ';
                    causasTexto += feedback.causas.join(', ');
                    const causasLines = doc.splitTextToSize(causasTexto, pageWidth - 2 * margin);
                    doc.text(causasLines, margin, yPos);
                    yPos += causasLines.length * 7 + 5;
                }
                
                // Explicación
                if (feedback.explicacion_causa) {
                    const explicacionTexto = `Explicación: ${feedback.explicacion_causa}`;
                    const explicacionLines = doc.splitTextToSize(explicacionTexto, pageWidth - 2 * margin);
                    doc.text(explicacionLines, margin, yPos);
                    yPos += explicacionLines.length * 7 + 5;
                }
                
                // Acción diferente
                if (feedback.accion_diferente) {
                    const accionTexto = `Acción diferente: ${feedback.accion_diferente}`;
                    const accionLines = doc.splitTextToSize(accionTexto, pageWidth - 2 * margin);
                    doc.text(accionLines, margin, yPos);
                    yPos += accionLines.length * 7 + 5;
                }
                
                // Compromiso
                const compromisoTexto = `Compromiso: ${feedback.compromiso || 'N/A'}`;
                const compromisoLines = doc.splitTextToSize(compromisoTexto, pageWidth - 2 * margin);
                doc.text(compromisoLines, margin, yPos);
                yPos += compromisoLines.length * 7 + 10;
                
            } else {
                doc.text('RAZÓN DE LA RETROALIMENTACIÓN', margin, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                const razonTexto = feedback.razon || 'N/A';
                const razonLines = doc.splitTextToSize(razonTexto, pageWidth - 2 * margin);
                doc.text(razonLines, margin, yPos);
                yPos += razonLines.length * 7 + 15;
            }
            
            // ============ FIRMAS ============
            if (feedback.firmas && Object.keys(feedback.firmas).length > 0) {
                if (yPos > pageHeight - 100) {
                    doc.addPage();
                    yPos = margin;
                }
                
                doc.setFontSize(14);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('FIRMAS', margin, yPos);
                yPos += 10;
                
                const firmaWidth = 80;
                const firmaHeight = 40;
                const espacioHorizontal = 10;
                const espacioVertical = 15;
                const firmasPorFila = 2;
                
                let xOffset = margin;
                let filaActual = 0;
                
                Object.entries(feedback.firmas).forEach(([persona, firmaDataURL], index) => {
                    if (index > 0 && index % firmasPorFila === 0) {
                        xOffset = margin;
                        yPos += firmaHeight + espacioVertical + 15;
                        filaActual++;
                        
                        if (yPos + firmaHeight + espacioVertical > pageHeight - margin) {
                            doc.addPage();
                            yPos = margin + 10;
                            filaActual = 0;
                        }
                    }
                    
                    // Nombre de la firma
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    const nombreFirma = persona === 'colaborador' ? 'Colaborador' :
                                       persona === 'supervisor' ? 'Supervisor' :
                                       persona === 'sindical' ? 'Líder Sindical' :
                                       persona === 'rh' ? 'Recursos Humanos' :
                                       persona.charAt(0).toUpperCase() + persona.slice(1);
                    doc.text(nombreFirma, xOffset + 5, yPos);
                    
                    // Cuadro para la firma
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(xOffset, yPos + 3, firmaWidth, firmaHeight);
                    
                    // Insertar imagen de la firma si existe
                    try {
                        if (firmaDataURL && firmaDataURL.startsWith('data:image')) {
                            doc.addImage(
                                firmaDataURL, 
                                'PNG', 
                                xOffset + 2, 
                                yPos + 5, 
                                firmaWidth - 4, 
                                firmaHeight - 4
                            );
                        }
                    } catch (e) {
                        console.log('No se pudo agregar firma:', e);
                    }
                    
                    xOffset += firmaWidth + espacioHorizontal;
                });
            }
            
            // ============ PIE DE PÁGINA ============
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(
                    `Página ${i} de ${totalPages} - Generado: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`,
                    pageWidth / 2,
                    pageHeight - 10,
                    null,
                    null,
                    'center'
                );
                
                // Línea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
            }
            
            // Guardar PDF
            doc.save(`Retroalimentacion_${feedback.folio}.pdf`);
            
        } catch (error) {
            console.error('Error generando PDF:', error);
            alert('Error al generar PDF: ' + error.message);
        }
    }

    async function exportGeneralPDF() {
        try {
            const { data: escritas } = await supabaseClient
                .from('retroalimentaciones_escritas')
                .select('*');
            
            const { data: verbales } = await supabaseClient
                .from('retroalimentaciones_verbales')
                .select('*');
            
            if ((!escritas || escritas.length === 0) && (!verbales || verbales.length === 0)) {
                alert('No hay datos para generar reporte');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('REPORTE GENERAL DE RETROALIMENTACIONES', 105, 20, null, null, 'center');
            
            doc.setFontSize(12);
            doc.text(`Fecha del reporte: ${new Date().toLocaleDateString()}`, 20, 35);
            doc.text(`Generado por: ${currentUser?.name || 'Sistema'}`, 20, 42);
            
            doc.setFontSize(14);
            doc.text('ESTADÍSTICAS', 20, 55);
            
            doc.setFontSize(11);
            let yPos = 65;
            
            const totalEscritas = escritas ? escritas.length : 0;
            const totalVerbales = verbales ? verbales.length : 0;
            const totalGeneral = totalEscritas + totalVerbales;
            
            doc.text(`Total retroalimentaciones: ${totalGeneral}`, 20, yPos);
            yPos += 8;
            doc.text(`Retroalimentaciones escritas: ${totalEscritas}`, 20, yPos);
            yPos += 8;
            doc.text(`Retroalimentaciones verbales: ${totalVerbales}`, 20, yPos);
            yPos += 8;
            
            if (escritas && escritas.length > 0) {
                const motivacion = escritas.filter(e => e.tipo_feedback === 'Motivación').length;
                const desarrollo = escritas.filter(e => e.tipo_feedback === 'Desarrollo').length;
                
                doc.text(`Motivación: ${motivacion}`, 20, yPos);
                yPos += 8;
                doc.text(`Desarrollo: ${desarrollo}`, 20, yPos);
                yPos += 15;
            }
            
            doc.setFontSize(14);
            doc.text('LISTA DE RETROALIMENTACIONES', 20, yPos);
            yPos += 10;
            
            const headers = [['Folio', 'Fecha', 'Tipo', 'N° Empleado', 'Nombre', 'Líder', 'Cuadrilla Colab']];
            const data = [];
            
            if (escritas) {
                escritas.forEach(item => {
                    data.push([
                        item.folio,
                        item.fecha,
                        'Escrita',
                        item.num_empleado,
                        item.nombre_colaborador || 'N/A',
                        item.lider_nombre?.split(' - ')[0] || 'N/A',
                        item.cuadrilla_colaborador || 'N/A'
                    ]);
                });
            }
            
            if (verbales) {
                verbales.forEach(item => {
                    data.push([
                        item.folio,
                        item.fecha,
                        'Verbal',
                        item.num_empleado,
                        item.nombre_colaborador || 'N/A',
                        item.lider_nombre?.split(' - ')[0] || 'N/A',
                        item.cuadrilla_colaborador || 'N/A'
                    ]);
                });
            }
            
            doc.autoTable({
                startY: yPos,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [207, 0, 46] }
            });
            
            doc.save(`Reporte_General_${new Date().toISOString().split('T')[0]}.pdf`);
            
        } catch (error) {
            console.error('Error generando reporte PDF:', error);
            alert('Error al generar reporte: ' + error.message);
        }
    }

    async function cargarFeedbacksParaPDF() {
        try {
            const select = document.getElementById('pdf-feedback-select');
            select.innerHTML = '<option value="">Cargando...</option>';
            
            const { data: escritas } = await supabaseClient
                .from('retroalimentaciones_escritas')
                .select('id, folio, fecha')
                .order('fecha', { ascending: false });
            
            const { data: verbales } = await supabaseClient
                .from('retroalimentaciones_verbales')
                .select('id, folio, fecha')
                .order('fecha', { ascending: false });
            
            select.innerHTML = '<option value="">Seleccione una retroalimentación</option>';
            
            if (escritas) {
                escritas.forEach(item => {
                    const option = document.createElement('option');
                    option.value = `escrita_${item.id}`;
                    option.textContent = `${item.folio} - Escrita (${item.fecha})`;
                    select.appendChild(option);
                });
            }
            
            if (verbales) {
                verbales.forEach(item => {
                    const option = document.createElement('option');
                    option.value = `verbal_${item.id}`;
                    option.textContent = `${item.folio} - Verbal (${item.fecha})`;
                    select.appendChild(option);
                });
            }
            
        } catch (error) {
            console.error('Error cargando feedbacks:', error);
            select.innerHTML = '<option value="">Error al cargar</option>';
        }
    }

    async function generateIndividualPDF() {
        const select = document.getElementById('pdf-feedback-select');
        const value = select.value;
        
        if (!value) {
            alert('Por favor seleccione una retroalimentación');
            return;
        }
        
        const [tipo, id] = value.split('_');
        
        closePdfModal();
        await generatePDF(parseInt(id), tipo === 'escrita' ? 'Escrita' : 'Verbal');
    }

    // ============================================
    // INICIALIZACIÓN PRINCIPAL
    // ============================================

    document.addEventListener('DOMContentLoaded', function() {
        initializeSupabase();
        
        setTimeout(() => {
            initializeAllCanvas();
            setupEventListeners();
            cargarLideres();
            actualizarFechas();
        }, 500);
         // Configurar evento de login
        document.getElementById('btn-login').addEventListener('click', handleLogin);
    });
    </script>
</body>
</html>
